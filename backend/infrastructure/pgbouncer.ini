[databases]
; Database connection pooling for hospitality platform
; Format: dbname = host=hostname port=port dbname=dbname

; Primary database (write operations)
hospitality = host=localhost port=5432 dbname=hospitality_platform user=postgres password=postgres

; Read replica (read operations) - Uncomment when replica is available
; hospitality_replica = host=localhost port=5433 dbname=hospitality_platform user=postgres password=postgres

; Fallback database
* = host=localhost port=5432

[pgbouncer]
;;;
;;; Administrative settings
;;;

; Log configuration
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

;;;
;;; Where to wait for clients
;;;

; Listen on all interfaces
listen_addr = 0.0.0.0
listen_port = 6432

; Unix socket is also used for local connections
;unix_socket_dir = /var/run/postgresql
;unix_socket_mode = 0777
;unix_socket_group =

;;;
;;; Authentication settings
;;;

; Authentication type: any, trust, plain, md5, cert, hba, pam
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

; Query to use to fetch password from database. Result must have 2 columns:
; username and password. It must return exactly 1 row.
;auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

;;;
;;; Pooler personality
;;;

; When server connection is released back to pool:
;   session      - after client disconnects (default)
;   transaction  - after transaction finishes
;   statement    - after statement finishes
pool_mode = transaction

; Query for cleaning connection immediately after releasing from client
;server_reset_query = DISCARD ALL
;server_reset_query_always = 0

; Whether server_reset_query should run in all pooling modes
;server_reset_query_always = 0

; Close server connection if its not been used in this time
server_idle_timeout = 600

; Maximum time queries are allowed to spend waiting for execution
query_wait_timeout = 120

;;;
;;; Connection limits
;;;

; Total number of clients that can connect
max_client_conn = 1000

; Default pool size for each user/database pair
default_pool_size = 25

; Minimum number of server connections to keep in pool
min_pool_size = 5

; Absolute maximum number of server connections per database
reserve_pool_size = 5

; Maximum time a server connection can be idle before being closed
reserve_pool_timeout = 3

; How many additional connections to allow to a pool
max_db_connections = 100

; Maximum number of server connections per user
max_user_connections = 100

;;;
;;; Connection sanity checks, timeouts
;;;

; Check if server conn is alive every N seconds
server_check_delay = 30

; DNS lookup caching time
dns_max_ttl = 15

; DNS lookup caching time for failed lookups
dns_nxdomain_ttl = 15

; Zone to use for loading balancing
;dns_zone_check_period = 0

; Close server connection if connect succeeds but login fails
server_login_retry = 15

; If server login failed (server_login_retry times) then wait this time before trying again
query_timeout = 0

; Client idle timeout
client_idle_timeout = 0

; Disconnect clients who have been waiting this long for a server connection
client_login_timeout = 60

; Close connection if no data sent by client in this time
;autodb_idle_timeout = 3600

;;;
;;; Dangerous timeouts
;;;

; How long to process login before closing the connection
;auth_timeout = 10

; If client idle for this long then disconnect
;client_login_timeout = 60

; How long can a query wait for a connection
;query_wait_timeout = 120

; Abort if server does not answer within this time
;server_lifetime = 3600

; Close server connection if its not been used for this time
;server_idle_timeout = 600

;;;
;;; Low-level tuning options
;;;

; Buffer size for TCP send/receive
pkt_buf = 4096

; How many buffers to allocate at once
sbuf_loopcnt = 5

; Allow suspending connections to avoid hitting max_client_conn
suspend_timeout = 10

;;;
;;; TLS settings
;;;

; Disable, allow or require TLS connections
;client_tls_sslmode = disable

; TLS key and certificate
;client_tls_key_file = /path/to/key.pem
;client_tls_cert_file = /path/to/cert.pem

; Root certificate file to verify server certificate
;client_tls_ca_file = /path/to/ca.pem

; How to verify server certificate
;server_tls_sslmode = prefer

; TLS protocols to support
;client_tls_protocols = secure

; Allowed TLS ciphers
;client_tls_ciphers = default

; Elliptic curve to use for ECDH key exchanges
;client_tls_ecdhcurve = auto

; Allowed TLS security levels
;client_tls_dheparams = auto

;;;
;;; Logging settings
;;;

; Syslog parameters
;syslog = 0
;syslog_facility = daemon
;syslog_ident = pgbouncer

; Log connections
log_connections = 1

; Log disconnections with reasons
log_disconnections = 1

; Log pooler errors and warnings
log_pooler_errors = 1

; Log queries over this duration (in seconds)
;log_stats = 60

; Period for writing aggregated stats into log
stats_period = 60

;;;
;;; Performance optimizations
;;;

; Use SO_REUSEPORT socket option
so_reuseport = 1

; TCP socket settings
tcp_keepalive = 1
tcp_keepcnt = 5
tcp_keepidle = 30
tcp_keepintvl = 10

; Network buffer sizes
tcp_socket_buffer = 0
tcp_defer_accept = 0

; User-space TCP buffering
tcp_user_timeout = 0

;;;
;;; Console access control
;;;

; User allowed to use the console
admin_users = postgres

; Database where the pooler can connect for internal queries
;stats_users = stats, postgres

; Database where the pooler can connect for internal queries
;ignore_startup_parameters = extra_float_digits

