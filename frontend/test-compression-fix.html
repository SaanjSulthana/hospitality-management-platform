<!DOCTYPE html>
<html>
<head>
    <title>Compression Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .results { margin-top: 10px; }
        .step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input[type="file"] { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîß Compression Fix Test</h1>
    
    <div class="test-section info">
        <h3>üìã Test Instructions</h3>
        <p>This test will verify that the compression algorithm is actually reducing file sizes.</p>
    </div>

    <div class="test-section">
        <h3>üìÅ File Selection</h3>
        <input type="file" id="fileInput" accept="image/*">
        <div id="fileInfo" class="results"></div>
    </div>

    <div class="test-section">
        <h3>üîÑ Compression Test</h3>
        <button onclick="testCompression()" id="compressBtn" disabled>Test Compression</button>
        <div id="compressionResults" class="results"></div>
    </div>

    <script>
        let selectedFile = null;

        // Fixed compression function
        function compressImage(file, targetSizeMB = 3) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = () => {
                    let { width, height } = img;
                    const maxDimension = 1200; // More aggressive
                    
                    if (width > maxDimension || height > maxDimension) {
                        const aspectRatio = width / height;
                        if (width > height) {
                            width = maxDimension;
                            height = width / aspectRatio;
                        } else {
                            height = maxDimension;
                            width = height * aspectRatio;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Try different quality levels
                    const qualityLevels = [0.6, 0.5, 0.4, 0.3, 0.2];
                    let currentQualityIndex = 0;
                    
                    const tryCompress = () => {
                        if (currentQualityIndex >= qualityLevels.length) {
                            reject(new Error('Could not compress to target size'));
                            return;
                        }
                        
                        const quality = qualityLevels[currentQualityIndex];
                        canvas.toBlob((blob) => {
                            if (!blob) {
                                reject(new Error('Compression failed'));
                                return;
                            }
                            
                            const compressedSizeMB = blob.size / (1024 * 1024);
                            const reductionRatio = (1 - blob.size / file.size) * 100;
                            
                            console.log(`Quality ${quality}: ${compressedSizeMB.toFixed(2)}MB, ${reductionRatio.toFixed(1)}% reduction`);
                            
                            // Accept if we got at least 20% reduction or reached target size
                            if (reductionRatio >= 20 || compressedSizeMB <= targetSizeMB) {
                                const compressedFile = new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                
                                resolve({
                                    compressedFile,
                                    originalSize: file.size,
                                    compressedSize: blob.size,
                                    compressionRatio: reductionRatio,
                                    quality
                                });
                            } else {
                                currentQualityIndex++;
                                tryCompress();
                            }
                        }, 'image/jpeg', quality);
                    };
                    
                    tryCompress();
                };

                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = URL.createObjectURL(file);
            });
        }

        // File selection handler
        document.getElementById('fileInput').addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                const fileSizeMB = (selectedFile.size / 1024 / 1024).toFixed(2);
                document.getElementById('fileInfo').innerHTML = `
                    <div class="step">
                        <strong>Selected File:</strong> ${selectedFile.name}<br>
                        <strong>Size:</strong> ${fileSizeMB}MB<br>
                        <strong>Type:</strong> ${selectedFile.type}
                    </div>
                `;
                document.getElementById('compressBtn').disabled = false;
            }
        });

        // Test compression
        async function testCompression() {
            if (!selectedFile) return;
            
            const results = document.getElementById('compressionResults');
            results.innerHTML = '<div class="step">üîÑ Testing compression...</div>';
            
            try {
                const result = await compressImage(selectedFile, 3);
                
                const originalMB = (result.originalSize / 1024 / 1024).toFixed(2);
                const compressedMB = (result.compressedSize / 1024 / 1024).toFixed(2);
                const ratio = result.compressionRatio.toFixed(1);
                
                if (result.compressionRatio > 0) {
                    results.innerHTML = `
                        <div class="step success">
                            ‚úÖ <strong>Compression Working!</strong><br>
                            Original: ${originalMB}MB ‚Üí Compressed: ${compressedMB}MB<br>
                            Reduction: ${ratio}%<br>
                            Quality: ${(result.quality * 100).toFixed(0)}%
                        </div>
                    `;
                } else {
                    results.innerHTML = `
                        <div class="step error">
                            ‚ùå <strong>No Compression Achieved</strong><br>
                            File size unchanged: ${originalMB}MB
                        </div>
                    `;
                }
            } catch (error) {
                results.innerHTML = `<div class="step error">‚ùå Compression failed: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
