<!DOCTYPE html>
<html>
<head>
    <title>Test Upload with Compression</title>
</head>
<body>
    <h1>Upload Test with Compression</h1>
    <input type="file" id="fileInput" accept="image/*">
    <div id="results"></div>

    <script>
        // Compression function
        function compressImage(file, targetSizeMB = 5) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = () => {
                    let { width, height } = img;
                    const maxDimension = 2048;
                    
                    if (width > maxDimension || height > maxDimension) {
                        const aspectRatio = width / height;
                        if (width > height) {
                            width = maxDimension;
                            height = width / aspectRatio;
                        } else {
                            height = maxDimension;
                            width = height * aspectRatio;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    let quality = 0.8;
                    const tryCompress = () => {
                        canvas.toBlob((blob) => {
                            if (!blob) {
                                reject(new Error('Compression failed'));
                                return;
                            }
                            
                            const compressedSizeMB = blob.size / (1024 * 1024);
                            
                            if (compressedSizeMB > targetSizeMB && quality > 0.3) {
                                quality -= 0.1;
                                tryCompress();
                                return;
                            }
                            
                            const compressedFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            
                            resolve({
                                compressedFile,
                                originalSize: file.size,
                                compressedSize: blob.size,
                                compressionRatio: (1 - blob.size / file.size) * 100,
                                quality
                            });
                        }, 'image/jpeg', quality);
                    };
                    
                    tryCompress();
                };

                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = URL.createObjectURL(file);
            });
        }

        // Base64 conversion
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const results = document.getElementById('results');
            results.innerHTML = `<p>Testing upload for: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)</p>`;

            try {
                // Step 1: Compress if needed
                let fileToUpload = file;
                let compressionInfo = '';
                
                const fileSizeMB = file.size / (1024 * 1024);
                if (fileSizeMB > 5) {
                    results.innerHTML += '<p>Compressing image...</p>';
                    const compressionResult = await compressImage(file, 10);
                    fileToUpload = compressionResult.compressedFile;
                    
                    const originalMB = (compressionResult.originalSize / 1024 / 1024).toFixed(2);
                    const compressedMB = (compressionResult.compressedSize / 1024 / 1024).toFixed(2);
                    const ratio = compressionResult.compressionRatio.toFixed(1);
                    
                    compressionInfo = ` (compressed from ${originalMB}MB to ${compressedMB}MB, ${ratio}% reduction)`;
                    results.innerHTML += `<p>✅ Compression successful: ${originalMB}MB → ${compressedMB}MB (${ratio}% reduction)</p>`;
                } else {
                    results.innerHTML += '<p>✅ File size acceptable, no compression needed</p>';
                }

                // Step 2: Convert to base64
                results.innerHTML += '<p>Converting to base64...</p>';
                const base64String = await fileToBase64(fileToUpload);
                const base64SizeMB = (base64String.length * 0.75) / (1024 * 1024);
                
                results.innerHTML += `<p>✅ Base64 conversion complete. Size: ${base64SizeMB.toFixed(2)}MB</p>`;
                
                if (base64SizeMB > 100) {
                    results.innerHTML += `<p style="color: red;">❌ Base64 size exceeds 100MB limit!</p>`;
                    return;
                }

                // Step 3: Test upload
                results.innerHTML += '<p>Testing upload to backend...</p>';
                
                const uploadPayload = {
                    documentType: 'passport',
                    fileData: base64String,
                    filename: fileToUpload.name,
                    mimeType: fileToUpload.type,
                    performExtraction: true,
                };
                
                const payloadSizeMB = (JSON.stringify(uploadPayload).length * 0.75) / (1024 * 1024);
                results.innerHTML += `<p>Upload payload size: ${payloadSizeMB.toFixed(2)}MB</p>`;
                
                if (payloadSizeMB > 500) {
                    results.innerHTML += `<p style="color: red;">❌ Payload size exceeds 500MB backend limit!</p>`;
                    return;
                }

                results.innerHTML += '<p>✅ All size checks passed! Upload should work.</p>';
                
            } catch (error) {
                results.innerHTML += `<p style="color: red;">Error: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
